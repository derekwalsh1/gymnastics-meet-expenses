import 'package:flutter_test/flutter_test.dart';
import 'package:integration_test/integration_test.dart';
import 'package:flutter/material.dart';
import 'package:nawgj_expense_tracker/main.dart' as app;

void main() {
  IntegrationTestWidgetsFlutterBinding.ensureInitialized();

  testWidgets('Complete app flow: Create AAU association, judges, and meet', (WidgetTester tester) async {
    app.main();
    await tester.pumpAndSettle();

    // Navigate to Judges
    final judgesTile = find.text('Judges');
    expect(judgesTile, findsOneWidget);
    await tester.tap(judgesTile);
    await tester.pumpAndSettle();
    expect(find.widgetWithText(AppBar, 'Judges'), findsOneWidget);

    // Open associations screen via settings icon
    await tester.tap(find.byTooltip('Manage Judge Levels'));
    await tester.pumpAndSettle();
    expect(find.widgetWithText(AppBar, 'Judge Associations'), findsOneWidget);

    Future<void> openAAULevels() async {
      final aauLevelsAppBar = find.widgetWithText(AppBar, 'AAU Levels');
      if (aauLevelsAppBar.evaluate().isNotEmpty) {
        return;
      }

      final aauTile = find.text('AAU');
      if (aauTile.evaluate().isEmpty) {
        // Add association through dialog
        await tester.tap(find.byType(FloatingActionButton));
        await tester.pumpAndSettle();
        await tester.enterText(find.byType(TextField).first, 'AAU');
        await tester.tap(find.widgetWithText(TextButton, 'Create'));
        await tester.pumpAndSettle();
        return;
      }

      await tester.tap(aauTile);
      await tester.pumpAndSettle();
    }

    await openAAULevels();
    await tester.pumpAndSettle();
    expect(find.widgetWithText(AppBar, 'AAU Levels'), findsOneWidget);

    Future<void> ensureLevel(String levelName, String hourlyRate) async {
      final levelFinder = find.text(levelName);
      if (levelFinder.evaluate().isNotEmpty) {
        return;
      }

      // Open add-level form (empty-state button or FAB)
      final addFirstLevelButton = find.widgetWithText(ElevatedButton, 'Add First Level');
      if (addFirstLevelButton.evaluate().isNotEmpty) {
        await tester.tap(addFirstLevelButton);
      } else {
        await tester.tap(find.byType(FloatingActionButton));
      }
      await tester.pumpAndSettle();

      await tester.enterText(find.bySemanticsLabel('Level'), levelName);
      await tester.enterText(find.bySemanticsLabel('Default Hourly Rate'), hourlyRate);
      await tester.tap(find.widgetWithText(ElevatedButton, 'Add Judge Level'));
      await tester.pumpAndSettle();
    }

    await ensureLevel('Local', '25');
    await ensureLevel('Regional', '35');
    await ensureLevel('National', '45');

    // Return to Judges screen
    await tester.pageBack();
    await tester.pumpAndSettle();
    await tester.pageBack();
    await tester.pumpAndSettle();
    expect(find.widgetWithText(AppBar, 'Judges'), findsOneWidget);

    Future<void> addJudgeWithLevel(String first, String last, String levelDisplay) async {
      await tester.tap(find.byType(FloatingActionButton));
      await tester.pumpAndSettle();
      expect(find.widgetWithText(AppBar, 'Add Judge'), findsOneWidget);

      await tester.enterText(find.bySemanticsLabel('First Name'), first);
      await tester.enterText(find.bySemanticsLabel('Last Name'), last);

      // Add certification via keyed button
      final addCertificationButton = find.byKey(const Key('add_certification_button'));
      expect(addCertificationButton, findsOneWidget);
      await tester.tap(addCertificationButton);
      await tester.pumpAndSettle();

      await tester.tap(find.bySemanticsLabel('Association'));
      await tester.pumpAndSettle();
      await tester.tap(find.text('AAU').last);
      await tester.pumpAndSettle();

      await tester.tap(find.bySemanticsLabel('Level'));
      await tester.pumpAndSettle();
      await tester.tap(find.text(levelDisplay).last);
      await tester.pumpAndSettle();

      await tester.tap(find.descendant(
        of: find.byType(AlertDialog),
        matching: find.widgetWithText(TextButton, 'Add'),
      ));
      await tester.pumpAndSettle();

      await tester.tap(find.widgetWithText(ElevatedButton, 'Add Judge'));
      await tester.pumpAndSettle();
    }

    await addJudgeWithLevel('Alice', 'Local', 'Local - \$25.00/hr');
    await addJudgeWithLevel('Bella', 'Regional', 'Regional - \$35.00/hr');
    await addJudgeWithLevel('Nina', 'National', 'National - \$45.00/hr');

    // Should now be back on Judges list - verify judges exist
    expect(find.widgetWithText(AppBar, 'Judges'), findsOneWidget);
    expect(find.text('Alice Local'), findsOneWidget);
    expect(find.text('Bella Regional'), findsOneWidget);
    expect(find.text('Nina National'), findsOneWidget);

    // Now create a meet
    final uniqueMeetName = 'Test Meet ${DateTime.now().millisecondsSinceEpoch}';

    // Navigate back to Home
    await tester.tap(find.byIcon(Icons.arrow_back));
    await tester.pumpAndSettle();
    expect(find.text('Welcome'), findsOneWidget);

    // Navigate to Events â†’ Create Event
    await tester.tap(find.byKey(const Key('events_quick_action')));
    await tester.pumpAndSettle();
    expect(find.widgetWithText(AppBar, 'Events'), findsOneWidget);
    
    await tester.tap(find.byType(FloatingActionButton));
    await tester.pumpAndSettle();
    expect(find.widgetWithText(AppBar, 'Create Event'), findsOneWidget);

    // Step 1: Basic info
    await tester.enterText(find.bySemanticsLabel('Event Name *'), uniqueMeetName);
    await tester.enterText(find.bySemanticsLabel('Venue Name *'), 'Test Venue');
    await tester.enterText(find.bySemanticsLabel('Address *'), '123 Main St');
    await tester.enterText(find.bySemanticsLabel('City *'), 'Springfield');
    await tester.enterText(find.bySemanticsLabel('State *'), 'CA');
    await tester.enterText(find.bySemanticsLabel('Zip *'), '90210');

    // Select AAU association from dropdown if available
    final associationDropdown = find.bySemanticsLabel('Association');
    if (associationDropdown.evaluate().isNotEmpty) {
      await tester.tap(associationDropdown);
      await tester.pumpAndSettle();
      final aauOption = find.text('AAU').last;
      if (aauOption.evaluate().isNotEmpty) {
        await tester.tap(aauOption);
        await tester.pumpAndSettle();
      }
    }

    // Pick start date (accept default)
    await tester.tap(find.text('Start Date *'));
    await tester.pumpAndSettle();
    final okButton = find.text('OK');
    final doneButton = find.text('Done');
    if (okButton.evaluate().isNotEmpty) {
      await tester.tap(okButton);
    } else if (doneButton.evaluate().isNotEmpty) {
      await tester.tap(doneButton);
    }
    await tester.pumpAndSettle();

    // Next to template selection
    await tester.tap(find.widgetWithText(ElevatedButton, 'Next'));
    await tester.pumpAndSettle();

    // Step 2: Choose Quick Meet template
    await tester.tap(find.text('Quick Meet').first);
    await tester.pumpAndSettle();

    // Next through structure step
    await tester.tap(find.widgetWithText(ElevatedButton, 'Next'));
    await tester.pumpAndSettle();

    // Step 4: Review and create
    await tester.tap(find.widgetWithText(ElevatedButton, 'Create Event'));
    await tester.pump();
    await tester.pumpAndSettle(const Duration(seconds: 5));

    // Verify we land on Events list and the new meet exists
    expect(find.widgetWithText(AppBar, 'Events'), findsOneWidget);
    expect(find.text(uniqueMeetName), findsOneWidget);
  });
}
